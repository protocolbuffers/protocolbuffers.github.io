<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>C++ Arena Allocation Guide | Protocol Buffers Documentation</title>
<meta name=description content="Arena allocation is a C++-only feature that helps you optimize your memory usage and improve performance when working with protocol buffers."><meta property="og:title" content="C++ Arena Allocation Guide"><meta property="og:description" content="Arena allocation is a C++-only feature that helps you optimize your memory usage and improve performance when working with protocol buffers."><meta property="og:type" content="article"><meta property="og:url" content="https://protobuf.dev/reference/cpp/arenas/"><meta property="article:section" content="reference"><meta itemprop=name content="C++ Arena Allocation Guide"><meta itemprop=description content="Arena allocation is a C++-only feature that helps you optimize your memory usage and improve performance when working with protocol buffers."><meta itemprop=wordCount content="3854"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="C++ Arena Allocation Guide"><meta name=twitter:description content="Arena allocation is a C++-only feature that helps you optimize your memory usage and improve performance when working with protocol buffers."><link rel=preload href=/scss/main.min.27bc098c9a8f7a1246d474f5c8afcee53760c9c7f38125d343ff52e0bf493011.css as=style integrity="sha256-J7wJjJqPehJG1HT1yK/O5TdgycfzgSXTQ/9S4L9JMBE=" crossorigin=anonymous><link href=/scss/main.min.27bc098c9a8f7a1246d474f5c8afcee53760c9c7f38125d343ff52e0bf493011.css rel=stylesheet integrity="sha256-J7wJjJqPehJG1HT1yK/O5TdgycfzgSXTQ/9S4L9JMBE=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-5L8P8GRN4Y"></script><script>var doNotTrack=!1,dnt;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5L8P8GRN4Y")}</script></head><body class=td-page><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>Protocol Buffers Documentation</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav></ul></div><div class="d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><div id=content-mobile><form class="td-sidebar__search d-flex align-items-center"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off></div><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form></div><div id=content-desktop></div><nav class="td-sidebar-nav collapse td-sidebar-nav--search-disabled" id=td-section-nav><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m--li><a href=/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-><span>Protocol Buffers</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-overview-li><a href=/overview/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-overview><span>Overview</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-installation-li><a href=/installation/ title="Protocol Buffer Compiler Installation" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-installation><span>Protoc Installation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-news-li><a href=/news/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-news><span>News</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-programming-guides-li><a href=/programming-guides/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-programming-guides><span>Programming Guides</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guideseditions-li><a href=/programming-guides/editions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guideseditions><span>Language Guide (editions)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesproto2-li><a href=/programming-guides/proto2/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesproto2><span>Language Guide (proto 2)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesproto3-li><a href=/programming-guides/proto3/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesproto3><span>Language Guide (proto 3)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesproto-limits-li><a href=/programming-guides/proto-limits/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesproto-limits><span>Proto Limits</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesstyle-li><a href=/programming-guides/style/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesstyle><span>Style Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesenum-li><a href=/programming-guides/enum/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesenum><span>Enum Behavior</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesencoding-li><a href=/programming-guides/encoding/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesencoding><span>Encoding</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesjson-li><a href=/programming-guides/json/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesjson><span>ProtoJSON Format</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidestechniques-li><a href=/programming-guides/techniques/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidestechniques><span>Techniques</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesaddons-li><a href=/programming-guides/addons/ title="Third-Party Add-ons" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesaddons><span>Add-ons</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesextension_declarations-li><a href=/programming-guides/extension_declarations/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesextension_declarations><span>Extension Declarations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesfield_presence-li><a href=/programming-guides/field_presence/ title="Application Note: Field Presence" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesfield_presence><span>Field Presence</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesserialization-not-canonical-li><a href=/programming-guides/serialization-not-canonical/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesserialization-not-canonical><span>Proto Serialization Is Not Canonical</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-programming-guidesdeserialize-debug-li><a href=/programming-guides/deserialize-debug/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-programming-guidesdeserialize-debug><span>Deserializing Debug Proto Representations</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-editions-li><a href=/editions/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-editions><span>Protobuf Editions</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-editionsoverview-li><a href=/editions/overview/ title="Protobuf Editions Overview" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-editionsoverview><span>Overview</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-editionsfeatures-li><a href=/editions/features/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-editionsfeatures><span>Feature Settings for Editions</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-editionsimplementation-li><a href=/editions/implementation/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-editionsimplementation><span>Implementing Editions Support</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-design-decisions-li><a href=/design-decisions/ title="Protobuf Team Design Decisions" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-design-decisions><span>Design Decisions</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-design-decisionsnullable-getters-setters-li><a href=/design-decisions/nullable-getters-setters/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-design-decisionsnullable-getters-setters><span>No Nullable Setters/Getters Support</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-best-practices-li><a href=/best-practices/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-best-practices><span>Proto Best Practices</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-best-practicesno-cargo-cults-li><a href=/best-practices/no-cargo-cults/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-best-practicesno-cargo-cults><span>Avoid Cargo Culting</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-best-practicesdos-donts-li><a href=/best-practices/dos-donts/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-best-practicesdos-donts><span>Proto Best Practices</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-best-practicesapi-li><a href=/best-practices/api/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-best-practicesapi><span>API Best Practices</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-best-practices1-1-1-li><a href=/best-practices/1-1-1/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-best-practices1-1-1><span>1-1-1 Best Practice</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-getting-started-li><a href=/getting-started/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-getting-started><span>Tutorials</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-getting-startedcpptutorial-li><a href=/getting-started/cpptutorial/ title="Protocol Buffer Basics: C++" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-getting-startedcpptutorial><span>C++</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-getting-startedcsharptutorial-li><a href=/getting-started/csharptutorial/ title="Protocol Buffer Basics: C#" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-getting-startedcsharptutorial><span>C#</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-getting-starteddarttutorial-li><a href=/getting-started/darttutorial/ title="Protocol Buffer Basics: Dart" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-getting-starteddarttutorial><span>Dart</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-getting-startedgotutorial-li><a href=/getting-started/gotutorial/ title="Protocol Buffer Basics: Go" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-getting-startedgotutorial><span>Go</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-getting-startedjavatutorial-li><a href=/getting-started/javatutorial/ title="Protocol Buffer Basics: Java" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-getting-startedjavatutorial><span>Java</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-getting-startedkotlintutorial-li><a href=/getting-started/kotlintutorial/ title="Protocol Buffer Basics: Kotlin" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-getting-startedkotlintutorial><span>Kotlin</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-getting-startedpythontutorial-li><a href=/getting-started/pythontutorial/ title="Protocol Buffer Basics: Python" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-getting-startedpythontutorial><span>Python</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-reference-li><a href=/reference/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-reference><span>Reference Guides</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-referencecpp-li><a href=/reference/cpp/ title="C++ Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referencecpp><span>C++</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencecppcpp-generated-li><a href=/reference/cpp/cpp-generated/ title="C++ Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencecppcpp-generated><span>Generated Code Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencecppstring-view-li><a href=/reference/cpp/string-view/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencecppstring-view><span>String View APIs</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-referencecpparenas-li><a href=/reference/cpp/arenas/ title="C++ Arena Allocation Guide" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-referencecpparenas><span class=td-sidebar-nav-active-item>Arena Allocation Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencecppabseil-li><a href=/reference/cpp/abseil/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencecppabseil><span>Abseil Support</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencecppapi-docs-link-li><a href=/reference/cpp/api-docs/ target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencecppapi-docs-link><span>C++ API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referencecsharp-li><a href=/reference/csharp/ title="C# Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referencecsharp><span>C#</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencecsharpcsharp-generated-li><a href=/reference/csharp/csharp-generated/ title="C# Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencecsharpcsharp-generated><span>Generated Code Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencecsharpapi-docs-link-li><a href=/reference/csharp/api-docs target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencecsharpapi-docs-link><span>C# API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referencedart-li><a href=/reference/dart/ title="Dart Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referencedart><span>Dart</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencedartdart-generated-li><a href=/reference/dart/dart-generated/ title="Dart Generated Code" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencedartdart-generated><span>Generated Code</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencedartapi-docs-link-li><a href=https://pub.dartlang.org/documentation/protobuf target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencedartapi-docs-link><span>Dart API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referencego-li><a href=/reference/go/ title="Go Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referencego><span>Go</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencegogo-generated-li><a href=/reference/go/go-generated/ title="Go Generated Code Guide (Open)" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencegogo-generated><span>Generated Code Guide (Open)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencegogo-generated-opaque-li><a href=/reference/go/go-generated-opaque/ title="Go Generated Code Guide (Opaque)" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencegogo-generated-opaque><span>Generated Code Guide (Opaque)</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencegofaq-li><a href=/reference/go/faq/ title="Go FAQ" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencegofaq><span>FAQ</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencegosize-li><a href=/reference/go/size/ title="Go Size Semantics" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencegosize><span>Size Semantics</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencegoapi-docs-link-li><a href=https://pkg.go.dev/google.golang.org/protobuf/proto target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencegoapi-docs-link><span>Go API</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencegoopaque-migration-li><a href=/reference/go/opaque-migration/ title="Go Opaque API Migration" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencegoopaque-migration><span>Opaque API Migration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencegoopaque-migration-manual-li><a href=/reference/go/opaque-migration-manual/ title="Go Opaque API: Manual Migration" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencegoopaque-migration-manual><span>Opaque API: Manual Migration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencegoopaque-faq-li><a href=/reference/go/opaque-faq/ title="Go Opaque API FAQ" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencegoopaque-faq><span>Opaque API FAQ</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referencejava-li><a href=/reference/java/ title="Java Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referencejava><span>Java</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencejavajava-generated-li><a href=/reference/java/java-generated/ title="Java Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencejavajava-generated><span>Generated Code Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencejavajava-proto-names-li><a href=/reference/java/java-proto-names/ title="Java Proto Names" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencejavajava-proto-names><span>Generated Proto Names</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencejavaapi-docs-link-li><a href=/reference/java/api-docs/overview-summary.html target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencejavaapi-docs-link><span>Java API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referencekotlin-li><a href=/reference/kotlin/ title="Kotlin Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referencekotlin><span>Kotlin</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencekotlinapi-docs-li><a href=/reference/kotlin/api-docs/ title="Kotlin Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referencekotlinapi-docs><span>Kotlin</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencekotlinkotlin-generated-li><a href=/reference/kotlin/kotlin-generated/ title="Kotlin Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencekotlinkotlin-generated><span>Generated Code Guide</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referenceobjective-c-li><a href=/reference/objective-c/ title="Objective-C Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referenceobjective-c><span>Objective-C</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceobjective-cobjective-c-generated-li><a href=/reference/objective-c/objective-c-generated/ title="Objective-C Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referenceobjective-cobjective-c-generated><span>Generated Code Guide</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referencephp-li><a href=/reference/php/ title="PHP Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referencephp><span>PHP</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencephpphp-generated-li><a href=/reference/php/php-generated/ title="PHP Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencephpphp-generated><span>Generated Code Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencephpapi-docs-link-li><a href=/reference/php/api-docs/ target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencephpapi-docs-link><span>PHP API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referencepython-li><a href=/reference/python/ title="Python Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referencepython><span>Python</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencepythonpython-generated-li><a href=/reference/python/python-generated/ title="Python Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencepythonpython-generated><span>Generated Code Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencepythonapi-docs-link-li><a href=https://googleapis.dev/python/protobuf/latest/ target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencepythonapi-docs-link><span>Python API</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referenceruby-li><a href=/reference/ruby/ title="Ruby Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referenceruby><span>Ruby</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencerubyruby-generated-li><a href=/reference/ruby/ruby-generated/ title="Ruby Generated Code Guide" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referencerubyruby-generated><span>Generated Code Guide</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referenceprotobuf-li><a href=/reference/protobuf/ title="Protocol Buffers Reference" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-referenceprotobuf><span>Protocol Buffers</span></a><ul class="ul-3 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceprotobufedition-2023-spec-li><a href=/reference/protobuf/edition-2023-spec/ title="Protocol Buffers Edition 2023 Language Specification" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referenceprotobufedition-2023-spec><span>2023 Language Specification</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceprotobufproto2-spec-li><a href=/reference/protobuf/proto2-spec/ title="Protocol Buffers Version 2 Language Specification" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referenceprotobufproto2-spec><span>Version 2 Language Specification</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceprotobufproto3-spec-li><a href=/reference/protobuf/proto3-spec/ title="Protocol Buffers Version 3 Language Specification" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referenceprotobufproto3-spec><span>Version 3 Language Specification</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceprotobuftextformat-spec-li><a href=/reference/protobuf/textformat-spec/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referenceprotobuftextformat-spec><span>Text Format Language Specification</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceprotobufgoogleprotobuf-li><a href=/reference/protobuf/google.protobuf/ title="Protocol Buffers Well-Known Types" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referenceprotobufgoogleprotobuf><span>Well-Known Types</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceother-li><a href=/reference/other/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-referenceother><span>Other Languages</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-support-li><a href=/support/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id=m-support><span>Support</span></a><ul class="ul-2 foldable"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-supportversion-support-li><a href=/support/version-support/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-supportversion-support><span>Version Support</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-supportmigration-li><a href=/support/migration/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-supportmigration><span>Migration Guide</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-supportcross-version-runtime-guarantee-li><a href=/support/cross-version-runtime-guarantee/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-supportcross-version-runtime-guarantee><span>Cross-Version Runtime Guarantee</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-downloads-li><a href=/downloads/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-downloads><span>Downloads</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-history-li><a href=/history/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-history><span>History</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-forum-link-li><a href=https://groups.google.com/g/protobuf target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-forum-link><span>Forum</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-navbar-li><a href=/navbar/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-navbar><span></span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-search-li><a href=/search/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-search><span>Search Results</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/protocolbuffers/protocolbuffers.github.io/tree/main/content/reference/cpp/arenas.md class=td-page-meta--view target=_blank rel=noopener><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
<a href=https://github.com/protocolbuffers/protocolbuffers.github.io/edit/main/content/reference/cpp/arenas.md class=td-page-meta--edit target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
<a href="https://github.com/protocolbuffers/protocolbuffers.github.io/new/main/content/reference/cpp/arenas.md?filename=change-me.md&amp;value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" class=td-page-meta--child target=_blank rel=noopener><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
<a href="https://github.com/protocolbuffers/protocolbuffers.github.io/issues/new?title=C++%20Arena%20Allocation%20Guide" class=td-page-meta--issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
<a href=https://github.com/protocolbuffers/protobuf/issues/new class=td-page-meta--project-issue target=_blank rel=noopener><i class="fa-solid fa-list-check fa-fw"></i> Create project issue</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#why>Why Use Arena Allocation?</a></li><li><a href=#gettingstarted>Getting Started</a></li><li><a href=#arenaclass>Arena Class API</a><ul><li><a href=#constructors>Constructors</a></li><li><a href=#allocation>Allocation Methods</a></li><li><a href=#owned-list>&ldquo;Owned list&rdquo; Methods</a></li><li><a href=#other-methods>Other Methods</a></li><li><a href=#thread-safety>Thread Safety</a></li></ul></li><li><a href=#messageclass>Generated Message Class</a><ul><li><a href=#message-class-methods>Message Class Methods</a></li><li><a href=#arenaembeddedmessage>Embedded Message Fields</a></li><li><a href=#arenastring>String Fields</a></li><li><a href=#arenarepeated>Repeated Fields</a></li></ul></li><li><a href=#usage>Usage Patterns and Best Practices</a><ul><li><a href=#unintended>Unintended Copies</a></li><li><a href=#granularity>Granularity</a></li></ul></li><li><a href=#example>Example</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><nav aria-label=breadcrumb class=td-breadcrumbs><ol class=breadcrumb><li class=breadcrumb-item><a href=/reference/>Reference Guides</a></li><li class=breadcrumb-item><a href=/reference/cpp/>C++</a></li><li class="breadcrumb-item active" aria-current=page>Arena Allocation Guide</li></ol></nav><div class=td-content><h1>C++ Arena Allocation Guide</h1><div class=lead>Arena allocation is a C++-only feature that helps you optimize your memory usage and improve performance when working with protocol buffers.</div><header class=article-meta></header><p>This page describes exactly what C++ code the protocol
buffer compiler generates in addition to the code described in the
<a href=/reference/cpp/cpp-generated>C++ Generated Code Guide</a>
when arena allocation is enabled. It assumes that you are familiar with the
material in the
<a href=/programming-guides/proto2>language guide</a> and the
<a href=/reference/cpp/cpp-generated>C++ Generated Code Guide</a>.</p><h2 id=why>Why Use Arena Allocation?</h2><p>Memory allocation and deallocation constitutes a significant fraction of CPU
time spent in protocol buffers code. By default, protocol buffers performs heap
allocations for each message object, each of its subobjects, and several field
types, such as strings. These allocations occur in bulk when parsing a message
and when building new messages in memory, and associated deallocations happen
when messages and their subobject trees are freed.</p><p>Arena-based allocation has been designed to reduce this performance cost. With
arena allocation, new objects are allocated out of a large piece of preallocated
memory called the arena. Objects can all be freed at once by discarding the
entire arena, ideally without running destructors of any contained object
(though an arena can still maintain a &ldquo;destructor list&rdquo; when required). This
makes object allocation faster by reducing it to a simple pointer increment, and
makes deallocation almost free. Arena allocation also provides greater cache
efficiency: when messages are parsed, they are more likely to be allocated in
continuous memory, which makes traversing messages more likely to hit hot cache
lines.</p><p>To get these benefits you&rsquo;ll need to be aware of object lifetimes and find a
suitable granularity at which to use arenas (for servers, this is often
per-request). You can find out more about how to get the most from arena
allocation in <a href=#usage>Usage patterns and best practices</a>.</p><p>This table summarizes the typical performance advantages and disadvantages of
using arenas:</p><table><thead><tr><th style=text-align:left>Operation</th><th style=text-align:left>Heap-allocated proto messages</th><th style=text-align:left>Arena-allocated proto messages</th></tr></thead><tbody><tr><td style=text-align:left><em>Message allocation</em></td><td style=text-align:left>Slower on average</td><td style=text-align:left>Faster on average</td></tr><tr><td style=text-align:left><em>Message destruction</em></td><td style=text-align:left>Slower on average</td><td style=text-align:left>Faster on average</td></tr><tr><td style=text-align:left><em>Message moves</em></td><td style=text-align:left>Always a move (equivalent to a <a href=https://en.wikipedia.org/wiki/Object_copying#Shallow_copy>shallow copy</a> in cost)</td><td style=text-align:left>Sometimes a <a href=https://en.wikipedia.org/wiki/Object_copying#Deep_copy>deep copy</a></td></tr></tbody></table><h2 id=gettingstarted>Getting Started</h2><p>The protocol buffer compiler generates code for arena allocation for the
messages in your file, as used in the following example.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;google/protobuf/arena.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Arena</span> <span style=color:#000>arena</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>  <span style=color:#000>MyMessage</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Arena</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Create</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyMessage</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>arena</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>  <span style=color:#8f5902;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The message object created by <code>Create()</code> exists for as long as <code>arena</code> exists,
and you should not <code>delete</code> the returned message pointer. All of the message
object&rsquo;s internal storage (with a few exceptions<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>) and submessages (for
example, submessages in a repeated field within <code>MyMessage</code>) are allocated on
the arena as well.</p><p>For the most part, the rest of your code will be the same as if you weren&rsquo;t
using arena allocation.</p><p>We&rsquo;ll look at the arena API in more detail in the following sections, and you
can see a more extensive <a href=#example>example</a> at the end of the document.</p><h2 id=arenaclass>Arena Class API</h2><p>You create message objects on the arena using the
<a href=/reference/cpp/api-docs/google.protobuf.arena.md><code>google::protobuf::Arena</code></a>
class. This class implements the following public methods.</p><h3 id=constructors>Constructors</h3><ul><li><code>Arena()</code>: Creates a new arena with default parameters, tuned for average
use cases.</li><li><code>Arena(const ArenaOptions& options)</code>: Creates a new arena that uses the
specified allocation options. The options available in <code>ArenaOptions</code>
include the ability to use an initial block of user-provided memory for
allocations before resorting to the system allocator, control over the
initial and maximum request sizes for blocks of memory, and allowing you to
pass in custom block allocation and deallocation function pointers to build
freelists and others on top of the blocks.</li></ul><h3 id=allocation>Allocation Methods</h3><ul><li><p><code>template&lt;typename T> static T* Create(Arena* arena)</code> or <code>template&lt;typename T> static T* Create(Arena* arena, args...)</code></p><ul><li><p>If <code>T</code> is fully compatible<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, then the method creates a new
protocol buffer object of type <code>T</code> and its subobjects on the arena.</p><p>If <code>arena</code> is not NULL, the returned object is allocated on the arena,
its internal storage and sub-types (if any) will be allocated on the
same arena, and its lifetime is the same as that of the arena. The
object must not be deleted/freed manually: the arena owns the object for
lifetime purposes.</p><p>If <code>arena</code> is NULL, the returned object is allocated on the heap, and
the caller owns the object upon return.</p></li><li><p>If <code>T</code> is a user-type, the method lets you create an object but not the
subobjects on the arena. For example, let&rsquo;s say you have this C++ class:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#204a87;font-weight:700>class</span> <span style=color:#000>MyCustomClass</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MyCustomClass</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>int</span> <span style=color:#000>arg2</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><p>&mldr;you can create an instance of it on the arena like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#204a87;font-weight:700>void</span> <span style=color:#000>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Arena</span> <span style=color:#000>arena</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MyCustomClass</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Arena</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Create</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyCustomClass</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>arena</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>constructor_arg1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>constructor_arg2</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div></li></ul></li></ul><ul><li><p><code>template&lt;typename T> static T* CreateArray(Arena* arena, size_t n)</code>: If
<code>arena</code> is not NULL, this method allocates raw storage for <code>n</code> elements of
type <code>T</code> and returns it. The arena owns the returned memory and will free it
on its own destruction. If <code>arena</code> is NULL, this method allocates storage on
the heap and the caller receives ownership.</p><p><code>T</code> must have a trivial constructor: constructors are not called when the
array is created on the arena.</p></li></ul><h3 id=owned-list>&ldquo;Owned list&rdquo; Methods</h3><p>The following methods let you specify that particular objects or destructors are
&ldquo;owned&rdquo; by the arena, ensuring that they are deleted or called when the arena
itself is deleted</p><ul><li><code>template&lt;typename T> void Own(T* object)</code>: Adds <code>object</code> to the arena&rsquo;s
list of owned heap objects. When the arena is destroyed, it traverses this
list and frees each object using operator delete, i.e., the system memory
allocator. This method is useful in cases when an object&rsquo;s lifetime should
be tied to the arena but, for whatever reason, the object itself cannot be
or was not already allocated on the arena.</li><li><code>template&lt;typename T> void OwnDestructor(T* object)</code>: Adds the destructor of
<code>object</code> to the arena&rsquo;s list of destructors to call. When the arena is
destroyed, it traverses this list and calls each destructor in turn. It does
not attempt to free the underlying memory of object. This method is useful
when an object is embedded in arena-allocated storage but its destructor
will not otherwise be called, for example because its containing class is a
protobuf message whose destructor won&rsquo;t be called, or because it was
manually constructed in a block allocated by <code>AllocateArray()</code>.</li></ul><h3 id=other-methods>Other Methods</h3><ul><li><code>uint64 SpaceUsed() const</code>: Returns the total size of the arena, which is
the sum of the sizes of the underlying blocks. This method is thread-safe;
however, if there are concurrent allocations from multiple threads this
method&rsquo;s return value may not include the sizes of those new blocks.</li><li><code>uint64 Reset()</code>: Destroys the arena&rsquo;s storage, first calling all registered
destructors and freeing all registered heap objects and then discarding all
arena blocks. This teardown procedure is equivalent to that which occurs
when the arena&rsquo;s destructor runs, except the arena is reusable for new
allocations after this method returns. Returns the total size used by the
arena: this information is useful for tuning performance.</li><li><code>template&lt;typename T> Arena* GetArena()</code>: Returns a pointer to this arena.
Not directly very useful but allows <code>Arena</code> to be used in template
instantiations that expect <code>GetArena()</code> methods to be present.</li></ul><h3 id=thread-safety>Thread Safety</h3><p><code>google::protobuf::Arena</code>&rsquo;s allocation methods are thread-safe, and the
underlying implementation goes to some length to make multithreaded allocation
fast. The <code>Reset()</code> method is <em>not</em> thread-safe: the thread performing the arena
reset must synchronize with all threads performing allocations or using objects
allocated from that arena first.</p><h2 id=messageclass>Generated Message Class</h2><p>The following message class members are changed or added when you enable arena
allocation.</p><h3 id=message-class-methods>Message Class Methods</h3><ul><li><code>Message(Message&& other)</code>: If the source message is not on arena, the move
constructor efficiently <em>moves</em> all fields from one message to another
without making copies or heap allocations (the time complexity of this
operation is <code>O(number-of-declared-fields)</code>). However, if the source message
is on arena, it performs a <em>deep copy</em> of the underlying data. In both cases
the source message is left in a valid but unspecified state.</li><li><code>Message& operator=(Message&& other)</code>: If both messages are not on arena or
are on the <em>same</em> arena, the move-assignment operator efficiently <em>moves</em>
all fields from one message to another without making copies or heap
allocations (the time complexity of this operation is
<code>O(number-of-declared-fields)</code>). However, if only one message is on arena,
or the messages are on different arenas, it performs a <em>deep copy</em> of the
underlying data. In both cases the source message is left in a valid but
unspecified state.</li><li><code>void Swap(Message* other)</code>: If both messages to be swapped are not on
arenas or are on the <em>same</em> arena,
<a href=/reference/cpp/cpp-generated#message><code>Swap()</code></a>
behaves as it does without having arena allocation enabled: it efficiently
swaps the message objects&rsquo; contents, almost exclusively through cheap
pointer swaps, avoiding copies. However, if only one message is on an arena,
or the messages are on different arenas, <code>Swap()</code> performs <em>deep copies</em> of
the underlying data. This new behavior is necessary because otherwise the
swapped sub-objects could have differing lifetimes, leading potentially to
use-after-free bugs.</li><li><code>Message* New(Arena* arena)</code>: An alternate override for the standard <code>New()</code>
method. It allows a new message object of this type to be created on the
given arena. Its semantics are identical to <code>Arena::Create&lt;T>(arena)</code> if the
concrete message type on which it is called is generated with arena
allocation enabled. If the message type is not generated with arena
allocation enabled, then it is equivalent to an ordinary allocation followed
by <code>arena->Own(message)</code> if <code>arena</code> is not NULL.</li><li><code>Arena* GetArena()</code>: Returns the arena on which this message object was
allocated, if any.</li><li><code>void UnsafeArenaSwap(Message* other)</code>: Identical to <code>Swap()</code>, except it
assumes both objects are on the same arena (or not on arenas at all) and
always uses the efficient pointer-swapping implementation of this operation.
Using this method can improve performance as, unlike <code>Swap()</code>, it doesn&rsquo;t
need to check which messages live on which arena before performing the swap.
As the <code>Unsafe</code> prefix suggests, you should only use this method if you are
sure the messages you want to swap aren&rsquo;t on different arenas; otherwise
this method could have unpredictable results.</li></ul><h3 id=arenaembeddedmessage>Embedded Message Fields</h3><p>When you allocate a message object on an arena, its embedded message field
objects (submessages) are automatically owned by the arena as well. How these
message objects are allocated depends on where they are defined:</p><ul><li>If the message type is also defined in a <code>.proto</code> file with arena allocation
enabled, the object is allocated on the arena directly.</li><li>If the message type is from another <code>.proto</code> without arena allocation
enabled, the object is heap-allocated but is &ldquo;owned&rdquo; by the parent message&rsquo;s
arena. This means that when the arena is destroyed, the object will be freed
along with the objects on the arena itself.</li></ul><p>For either of these field definitions:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>Bar</span> <span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>required</span> <span style=color:#000>Bar</span> <span style=color:#000>foo</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>The following methods are added or have some special behavior when arena
allocation is enabled. Otherwise, accessor methods just use the
<a href=/reference/cpp/cpp-generated#embeddedmessage>default behavior</a>.</p><ul><li><code>Bar* mutable_foo()</code>: Returns a mutable pointer to the submessage instance.
If the parent object is on an arena then the returned object will be as
well.</li><li><code>void set_allocated_foo(Bar* bar)</code>: Takes a new object and adopts it as the
new value for the field. Arena support adds additional copying semantics to
maintain proper ownership when objects cross arena/arena or arena/heap
boundaries:<ul><li>If the parent object is on the heap and <code>bar</code> is on the heap, or if the
parent and message are on the same arena, this method&rsquo;s behavior is
unchanged.</li><li>If the parent is on an arena and <code>bar</code> is on the heap, the parent
message adds <code>bar</code> to its arena&rsquo;s ownership list with <code>arena->Own()</code>.</li><li>If the parent is on an arena and <code>bar</code> is on a different arena, this
method makes a copy of message and takes the copy as the new field
value.</li></ul></li><li><code>Bar* release_foo()</code>: Returns the existing submessage instance of the field,
if set, or a NULL pointer if not set, releasing ownership of this instance
to the caller and clearing the parent message&rsquo;s field. Arena support adds
additional copying semantics to maintain the contract that the returned
object is always <em>heap-allocated</em>:<ul><li>If the parent message is on an arena, this method will make a copy of
the submessage on the heap, clear the field value, and return the copy.</li><li>If the parent message is on the heap, the method behavior is unchanged.</li></ul></li><li><code>void unsafe_arena_set_allocated_foo(Bar* bar)</code>: Identical to
<code>set_allocated_foo</code>, but assumes both parent and submessage are on the same
arena. Using this version of the method can improve performance as it
doesn&rsquo;t need to check whether the messages are on a particular arena or the
heap. See <a href=#set-allocated>allocated/release patterns</a> for details on safe
ways to use this.</li><li><code>Bar* unsafe_arena_release_foo()</code>: Similar to <code>release_foo()</code>, but skips all
ownership checking. See <a href=#set-allocated>allocated/release patterns</a> for
details on safe ways to use this.</li></ul><h3 id=arenastring>String Fields</h3><p>String fields store their data on the heap even when their parent message is on the arena. Because of this, string accessor methods use the <a href=/reference/cpp/cpp-generated#string>default behavior</a> even when arena allocation is enabled.</p><h3 id=arenarepeated>Repeated Fields</h3><p>Repeated fields allocate their internal array storage on the arena when the
containing message is arena-allocated, and also allocate their elements on the
arena when these elements are separate objects retained by pointer (messages or
strings). At the message-class level, generated methods for repeated fields do
not change. However, the <code>RepeatedField</code> and <code>RepeatedPtrField</code> objects that are
returned by accessors do have new methods and modified semantics when arena
support is enabled.</p><h4 id=repeated-numeric>Repeated Numeric Fields</h4><p><code>RepeatedField</code> objects that contain primitive types have the following
new/changed methods when arena allocation is enabled:</p><ul><li><code>void UnsafeArenaSwap(RepeatedField* other)</code>: Performs a swap of
<code>RepeatedField</code> contents without validating that this repeated field and
other are on the same arena. If they are not, the two repeated field objects
must be on arenas with equivalent lifetimes. The case where one is on an
arena and one is on the heap is checked and disallowed.</li><li><code>void Swap(RepeatedField* other)</code>: Checks each repeated field object&rsquo;s
arena, and if one is on an arena while one is on the heap or if both are on
arenas but on different ones, the underlying arrays are copied before the
swap occurs. This means that after the swap, each repeated field object
holds an array on its own arena or heap, as appropriate.</li></ul><h4 id=repeated-embedded>Repeated Embedded Message Fields</h4><p><code>RepeatedPtrField</code> objects that contain messages have the following new/changed
methods when arena allocation is enabled.</p><ul><li><p><code>void UnsafeArenaSwap(RepeatedPtrField* other)</code>: Performs a swap of
<code>RepeatedPtrField</code> contents without validating that this repeated field and
other have the same arena pointer. If they do not, the two repeated field
objects must have arena pointers with equivalent lifetimes. The case where
one has a non-NULL arena pointer and one has a NULL arena pointer is checked
and disallowed.</p></li><li><p><code>void Swap(RepeatedPtrField* other)</code>: Checks each repeated field object&rsquo;s
arena pointer, and if one is non-NULL (contents on arena) while one is NULL
(contents on heap) or if both are non-NULL but have different values, the
underlying arrays and their pointed-to objects are copied before the swap
occurs. This means that after the swap, each repeated field object holds an
array on its own arena or on the heap, as appropriate.</p></li><li><p><code>void AddAllocated(SubMessageType* value)</code>: Checks that the provided message
object is on the same arena as the repeated field&rsquo;s arena pointer.</p><ul><li>The source and destination are both arena-allocated and on the same
arena: the object pointer is added directly to the underlying array.</li><li>The source and destination are both arena-allocated and on different
arenas: a copy is made, the original is freed if it was heap-allocated,
and the copy is placed on the array.</li><li>The source is heap-allocated and the destination is arena-allocated: No
copy is made.</li><li>The source is arena-allocated and the destination is heap-allocated: A
copy is made and placed on the array.</li><li>Both source and destination are heap allocated: The object pointer is
added directly to the underlying array.</li></ul><p>This maintains the invariant that all objects pointed to by a repeated field
are in the same ownership domain (heap or specific arena) as indicated by
the repeated field&rsquo;s arena pointer.</p></li><li><p><code>SubMessageType* ReleaseLast()</code>: Returns a heap-allocated message equivalent
to the last message in the repeated field, removing it from the repeated
field. If the repeated field itself has a NULL arena pointer (and thus, all
of its pointed-to messages are heap-allocated), then this method simply
returns a pointer to the original object. Otherwise, if the repeated field
has a non-NULL arena pointer, this method makes a copy that is
heap-allocated and returns that copy. In both cases, the caller receives
ownership of a heap-allocated object and is responsible for deleting the
object.</p></li><li><p><code>void UnsafeArenaAddAllocated(SubMessageType* value)</code>: Like
<code>AddAllocated()</code>, but does not perform heap/arena checks or any message
copies. It adds the provided pointer directly to the internal array of
pointers for this repeated field. See
<a href=#set-allocated>allocated/release patterns</a> for details on safe ways to use
this.</p></li><li><p><code>SubMessageType* UnsafeArenaReleaseLast()</code>: Like <code>ReleaseLast()</code> but
performs no copies, even if the repeated field has a non-NULL arena pointer.
Instead, it directly returns the pointer to the object as it was in the
repeated field. See <a href=#set-allocated>allocated/release patterns</a> for details
on safe ways to use this.</p></li><li><p><code>void ExtractSubrange(int start, int num, SubMessageType** elements)</code>:
Removes <code>num</code> elements from the repeated field, starting from index <code>start</code>,
and returns them in <code>elements</code> if it is not NULL. If the repeated field is
on an arena, and elements are being returned, the elements are copied to the
heap first. In both cases (arena or no arena), the caller owns the returned
objects on the heap.</p></li><li><p><code>void UnsafeArenaExtractSubrange(int start, int num, SubMessageType** elements)</code>: Removes <code>num</code> elements from the repeated field, starting from
index <code>start</code>, and returns them in <code>elements</code> if it is not NULL. Unlike
<code>ExtractSubrange()</code>, this method never copies the extracted elements. See
<a href=#set-allocated>allocated/release patterns</a> for details on safe ways to use
this.</p></li></ul><h4 id=repeated-string>Repeated String Fields</h4><p>Repeated fields of strings have the same new methods and modified semantics as
repeated fields of messages, because they also maintain their underlying objects
(namely, strings) by pointer reference.</p><h2 id=usage>Usage Patterns and Best Practices</h2><p>When using arena-allocated messages, several usage patterns can result in
unintended copies or other negative performance effects. You should be aware of
the following common patterns that may need to be altered when adapting code for
arenas. (Note that we have taken care in the API design to ensure that correct
behavior still occurs &mdash; but higher-performance solutions may require some
reworking.)</p><h3 id=unintended>Unintended Copies</h3><p>Several methods that never create object copies when not using arena allocation
may end up doing so when arena support is enabled. These unwanted copies can be
avoided if you make sure that your objects are allocated appropriately and/or
use provided arena-specific method versions, as described in more detail below.</p><h4 id=set-allocated>Set Allocated/Add Allocated/Release</h4><p>By default, the <code>release_field()</code> and <code>set_allocated_field()</code> methods (for
singular message fields), and the <code>ReleaseLast()</code> and <code>AddAllocated()</code> methods
(for repeated message fields) allow user code to directly attach and detach
submessages, passing ownership of pointers without copying any data.</p><p>However, when the parent message is on an arena, these methods now sometimes
need to copy the passed in or returned object to maintain compatibility with
existing ownership contracts. More specifically, methods that take ownership
(<code>set_allocated_field()</code> and <code>AddAllocated()</code>) may copy data if the parent is on
an arena and the new subobject is not, or vice versa, or they are on different
arenas. Methods that release ownership (<code>release_field()</code> and <code>ReleaseLast()</code>)
may copy data if the parent is on the arena, because the returned object must be
on the heap, by contract.</p><p>To avoid such copies, we have added corresponding &ldquo;unsafe arena&rdquo; versions of
these methods where copies are <strong>never performed</strong>:
<code>unsafe_arena_set_allocated_field()</code>, <code>unsafe_arena_release_field()</code>,
<code>UnsafeArenaAddAllocated()</code>, and <code>UnsafeArenaRelease()</code> for singular and
repeated fields, respectively. These methods should be used only when you know
they are safe to do so. There are two common patterns for these methods:</p><ul><li>Moving messages trees between parts of the same arena. Note that the
messages must be on the same arena for this case to be safe.</li><li>Temporarily loaning an owned message to a tree to avoid copies. Pairing an
unsafe <em>add</em>/<em>set</em> method with an unsafe <em>release</em> method performs the loan
in the cheapest way possible regardless of how either message is owned (this
pattern works when they are on the same arena, different arena, or no arena
at all). Note that between the unsafe <em>add</em>/<em>set</em> and its corresponding
<em>release</em>, the borrower must not be swapped, moved, cleared or destroyed;
the loaned message must not be swapped or moved; the loaned message must not
be cleared or released by the borrower; and the loaned message must not be
destroyed.</li></ul><p>Here&rsquo;s an example of how you can avoid unnecessary copies with these methods.
Let&rsquo;s say you have created the following messages on an arena.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>Arena</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>arena</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Arena</span><span style=color:#000;font-weight:700>();</span>
</span></span><span style=display:flex><span><span style=color:#000>MyFeatureMessage</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>arena_message_1</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>  <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Arena</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Create</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyFeatureMessage</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arena</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>arena_message_1</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mutable_nested_message</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_feature_id</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>MyFeatureMessage</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>arena_message_2</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>  <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Arena</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Create</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyFeatureMessage</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arena</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><p>The following code makes inefficient usage of the <code>release_...()</code> API:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>arena_message_2</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_allocated_nested_message</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arena_message_1</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>release_nested_message</span><span style=color:#000;font-weight:700>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>arena_message_1</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>release_message</span><span style=color:#000;font-weight:700>();</span> <span style=color:#8f5902;font-style:italic>// returns a copy of the underlying nested_message and deletes underlying pointer
</span></span></span></code></pre></div><p>Using the &ldquo;unsafe arena&rdquo; version instead avoids the copy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>arena_message_2</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>unsafe_arena_set_allocated_nested_message</span><span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>   <span style=color:#000>arena_message_1</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>unsafe_arena_release_nested_message</span><span style=color:#000;font-weight:700>());</span>
</span></span></code></pre></div><p>You can find out more about these methods in the
<a href=#arenaembeddedmessage>Embedded message fields</a> section above.</p><h4 id=swap>Swap</h4><p>When two messages&rsquo; contents are swapped with <code>Swap()</code>, the underlying subobjects
may be copied if the two messages live on different arenas, or if one is on the
arena and the other is on the heap. If you want to avoid this copy and either
(i) know that the two messages are on the same arena or different arenas but the
arenas have equivalent lifetimes, or (ii) know that the two messages are on the
heap, you can use a new method, <code>UnsafeArenaSwap()</code>. This method both avoids the
overhead of performing the arena check and avoids the copy if one would have
occurred.</p><p>For example, the following code incurs a copy in the <code>Swap()</code> call:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>MyFeatureMessage</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>message_1</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>  <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Arena</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Create</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyFeatureMessage</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arena</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>message_1</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mutable_nested_message</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_feature_id</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>11</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>MyFeatureMessage</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>message_2</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>new</span> <span style=color:#000>MyFeatureMessage</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000>message_2</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mutable_nested_message</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_feature_id</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>22</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>message_1</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>Swap</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>message_2</span><span style=color:#000;font-weight:700>);</span> <span style=color:#8f5902;font-style:italic>// Inefficient swap!
</span></span></span></code></pre></div><p>To avoid the copy in this code, you allocate <code>message_2</code> on the same arena as
<code>message_1</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#000>MyFeatureMessage</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>message_2</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>   <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Arena</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Create</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyFeatureMessage</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>arena</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><h3 id=granularity>Granularity</h3><p>We have found in most application server use cases that an &ldquo;arena-per-request&rdquo;
model works well. You may be tempted to divide arena use further, either to
reduce heap overhead (by destroying smaller arenas more often) or to reduce
perceived thread-contention issues. However, the use of more fine-grained arenas
may lead to unintended message copying, as we describe above. We have also spent
effort to optimize the <code>Arena</code> implementation for the multithreaded use-case, so
a single arena should be appropriate for use throughout a request lifetime even
if multiple threads process that request.</p><h2 id=example>Example</h2><p>Here&rsquo;s a simple complete example demonstrating some of the features of the arena
allocation API.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// my_feature.proto
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000>syntax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;proto2&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;nested_message.proto&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>feature_package</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// NEXT Tag to use: 4
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>MyFeatureMessage</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>string</span> <span style=color:#000>feature_name</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>repeated</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>feature_data</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#000>NestedMessage</span> <span style=color:#000>nested_message</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>};</span><span style=color:#a40000>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-proto data-lang=proto><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// nested_message.proto
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000>syntax</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;proto2&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>feature_package</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>// NEXT Tag to use: 2
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>message</span> <span style=color:#000>NestedMessage</span> <span style=color:#000;font-weight:700>{</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>  <span style=color:#204a87;font-weight:700>optional</span> <span style=color:#204a87;font-weight:700>int32</span> <span style=color:#000>feature_id</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#000;font-weight:700>};</span><span style=color:#a40000>
</span></span></span></code></pre></div><p>Message construction and deallocation:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#include</span> <span style=color:#8f5902;font-style:italic>&lt;google/protobuf/arena.h&gt;</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#000>Arena</span> <span style=color:#000>arena</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>MyFeatureMessage</span><span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>arena_message</span> <span style=color:#ce5c00;font-weight:700>=</span>
</span></span><span style=display:flex><span>   <span style=color:#000>google</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>protobuf</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Arena</span><span style=color:#ce5c00;font-weight:700>::</span><span style=color:#000>Create</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>MyFeatureMessage</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>arena</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>arena_message</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_feature_name</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Proto2 Arena&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>arena_message</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mutable_feature_data</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>Add</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>arena_message</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mutable_feature_data</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>Add</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>);</span>
</span></span><span style=display:flex><span><span style=color:#000>arena_message</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>mutable_nested_message</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>-&gt;</span><span style=color:#000>set_feature_id</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>247</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Currently, string fields store their data on the heap even when the
containing message is on the arena. Unknown fields are also
heap-allocated.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>What it takes to be a &ldquo;fully compatible&rdquo; type is internal to the
protobuf library, and should not be assumed to be reliable.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank rel=noopener href=https://stackoverflow.com/questions/tagged/protocol-buffers aria-label="Stack Overflow"><i class="fab fa-stack-overflow"></i></a></li></ul><script type=text/javascript id=cookiebanner src=https://cdn.jsdelivr.net/gh/dobarkod/cookie-banner@1.2.2/dist/cookiebanner.min.js data-height=50px data-message="Protobuf.dev uses cookies from Google to deliver and enhance the quality of its services and to analyze traffic." data-bg=#ffb data-fg=#000 data-position=bottom data-padding="10px 16px" data-close-text="OK, got it" data-font-size=18px data-moreinfo=https://policies.google.com/technologies/cookies></script></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/protocolbuffers/protobuf aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/protobuf aria-label="Developer mailing list"><i class="fa fa-envelope"></i></a></li></ul><script type=text/javascript id=cookiebanner src=https://cdn.jsdelivr.net/gh/dobarkod/cookie-banner@1.2.2/dist/cookiebanner.min.js data-height=50px data-message="Protobuf.dev uses cookies from Google to deliver and enhance the quality of its services and to analyze traffic." data-bg=#ffb data-fg=#000 data-position=bottom data-padding="10px 16px" data-close-text="OK, got it" data-font-size=18px data-moreinfo=https://policies.google.com/technologies/cookies></script></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2025 Google LLC All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></small>
<span class=text-white>Hosted by GitHub Pages.</span> <a href=https://docs.github.com/en/site-policy/privacy-policies/github-privacy-statement target=_blank>GitHub Privacy Statement</a></div></div></div></footer></div><script src=/js/main.min.c91cdfdcc1576ecc360abc6f1c3ca0485d047f65ac6d3203ec57ed29e0af808b.js integrity="sha256-yRzf3MFXbsw2CrxvHDygSF0Ef2WsbTID7FftKeCvgIs=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>